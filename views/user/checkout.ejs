<html>
<head>
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100" style="font-family: 'Roboto', sans-serif;">

  <%- include("../partials/user/header") %>

  <div class="container mx-auto mt-8">
    <h1 class="text-3xl font-bold text-center mb-6">Checkout</h1>

    <!-- Cart Items -->
    <div class="bg-white p-6 shadow-md">
      <h2 class="font-bold text-lg mb-4">Order Summary</h2>
      <table class="w-full">
        <thead>
          <tr class="bg-gray-200">
            <th class="py-2 px-4">Product</th>
            <th class="py-2 px-4">Price</th>
            <th class="py-2 px-4">Quantity</th>
            <th class="py-2 px-4">Total</th>
          </tr>
        </thead>
        <tbody>
            <% if (cartItems && cartItems.length > 0) { %>
                <% cartItems.forEach(item => { %>
                  
                  <tr class="border-b">
                    <td class="py-4 px-4 flex items-center">
                      <img src="<%= item.productId.productImage[0] %>" class="w-16 h-16 mr-4" alt="Product Image">
                      <div>
                        <h2 class="font-bold"><%= item.productId.productName %></h2>
                        <p><%= item.productId.description %></p>
                      </div>
                    </td>
                    <td class="py-4 px-4">₹<%= item.productId.salePrice %></td>
                    <td class="py-4 px-4"><%= item.quantity %></td>
                    <td class="py-4 px-4">₹<%= item.totalPrice %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4" class="text-center py-4">Your cart is empty</td>
                </tr>
              <% } %>
              
        </tbody>
      </table>
    </div>

<!-- Cart Total -->
<div class="bg-white p-6 shadow-md mt-6">
  <h2 class="font-bold text-lg mb-4">Cart Totals</h2>
  


  <!-- Total Discount (if any) -->
  <% if (totalDiscount > 0) { %>
    <div class="flex justify-between text-md text-green-600 font-bold">
      <span>Discount Applied</span>
      <span>- ₹<%= totalDiscount.toFixed(2) %></span>
    </div>
  <% } %>

  <!-- Grand Total (After Discount) -->
  <div class="flex justify-between font-bold text-lg mt-2">
    <span>Total</span>
    <span>₹<%= grandTotal.toFixed(2) %></span>
  </div>
</div>


<div class="bg-white p-6 shadow-md mt-6">
    <h2 class="font-bold text-lg mb-4">Select Delivery Address</h2>
    
    <div class="bg-white p-6 shadow-md mt-6">
        <h2 class="font-bold text-lg mb-4">Select Delivery Address</h2>
        
        <% if (addresses && addresses.length > 0) { %>
          <% addresses.forEach(addressDoc => { %>
            <% addressDoc.address.forEach((address, index) => { %>
                <script>console.log("Address ID:", "<%= address._id %>");</script>
                <label class="block border p-4 rounded-lg mb-2 cursor-pointer">
                    <input type="radio" name="selectedAddress" value="<%= address._id %>" <%= index === 0 ? 'checked' : '' %> >
                    <span class="ml-2 font-semibold"><%= address.name %></span>
                    <p class="ml-6 text-sm text-gray-600">
                        <%= address.streetAddress %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %>
                    </p>
                </label>
            <% }) %>
        <% }) %>
        <% } else { %>
          <p class="text-red-500">No saved addresses. Please add one in your profile.</p>
        <% } %>
      
        <a href="/add-address" class="bg-blue-500 text-white px-4 py-2 rounded-md mt-2">
          + Add New Address
        </a>
    </div>

    <!-- Payment & Checkout -->
    <div class="bg-white p-6 shadow-md mt-6">
      <h2 class="font-bold text-lg mb-4">Payment Method</h2>
      <div>
        <label class="block">
          <input type="radio" name="payment" value="cod" checked /> Cash on Delivery
        </label>
      </div>
      <button onclick="placeOrder()" class="bg-teal-500 text-white px-6 py-3 rounded-full w-full mt-4">
        Place Order
      </button>
    </div>
  </div>

  <script>
        async function placeOrder() {
  try {
    const addressId = document.querySelector("input[name='selectedAddress']:checked")?.value;
console.log("✅ Selected Address ID:", addressId);

    if (!addressId) {
      Swal.fire({
        icon: "warning",
        title: "Select an Address",
        text: "Please select an address before placing an order.",
        confirmButtonColor: "#d33"
      });
      return;
    }

    const response = await fetch("/place-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ addressId }) // Send required data
    });

    const data = await response.json();
    console.log("Server Response:", data); // Debugging

    if (response.ok && data.success) {
      Swal.fire({
        icon: "success",
        title: "Order Placed!",
        text: "Your order has been successfully placed.",
        confirmButtonColor: "#3085d6"
      }).then(() => {
        window.location.href = "/orders"; 
      });
    } else {
      Swal.fire({
        icon: "error",
        title: "Oops!",
        text: data.message || "Something went wrong.",
        confirmButtonColor: "#d33"
      });
    }
  } catch (error) {
    console.error("Error placing order:", error);
    Swal.fire({
      icon: "error",
      title: "Error",
      text: "Failed to connect to the server. Please try again.",
      confirmButtonColor: "#d33"
    });
  }
}

  </script>
  
</body>
</html>
